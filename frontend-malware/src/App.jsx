import React, { useState, useEffect } from 'react';
import Dropzone from './components/Dropzone';
import ResultModal from './components/ResultModal';
import History from './components/History';

const API_URL = "http://localhost:8000";

function App() {
  const [history, setHistory] = useState([]);
  const [modalResult, setModalResult] = useState(null);
  const [loading, setLoading] = useState(false);

  const fetchHistory = async () => {
    try {
      const res = await fetch(`${API_URL}/history`);
      if (res.ok) {
        const data = await res.json();
        setHistory(data);
      }
    } catch (err) {
      console.error("Failed to fetch history:", err);
    }
  };

  useEffect(() => {
    fetchHistory();
  }, []);

  const handleFileScan = async (file) => {
    setLoading(true);
    const formData = new FormData();
    formData.append("file", file);

    try {
      // Fake delay for effect
      await new Promise(resolve => setTimeout(resolve, 1500));

      const res = await fetch(`${API_URL}/scan`, {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        const result = await res.json();
        setModalResult(result);
        fetchHistory(); // Refresh history
      } else {
        alert("Scan failed!");
      }
    } catch (err) {
      console.error("Error scanning file:", err);
      alert("Error scanning file. Ensure backend is running.");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="App">
      <main style={{ maxWidth: '800px', margin: '0 auto', padding: '2rem' }}>
        <h1 className="title-gradient">üõ°Ô∏è AntiGravity Defender</h1>

        <div className="glass glass-panel">
          <h2 style={{ textAlign: 'center', marginBottom: '2rem' }}>Malware Scanner</h2>
          {loading ? (
            <div style={{ textAlign: 'center', padding: '3rem' }}>
              <div className="loader"></div>
              <p style={{ marginTop: '1rem', color: 'var(--primary-color)' }}>Scanning files...</p>
            </div>
          ) : (
            <Dropzone onFileSelected={handleFileScan} />
          )}
        </div>

        <History history={history} />
      </main>

      {modalResult && (
        <ResultModal
          result={modalResult}
          onClose={() => setModalResult(null)}
        />
      )}
    </div>
  );
}

export default App;
